# ç®€åŒ–ç‰ˆ GMP æ¨¡å‹æµ‹è¯•è®¡åˆ’

## æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£ä»**å…¨å±€è§†è§’**è§„åˆ’ç®€åŒ–ç‰ˆ GMP è°ƒåº¦æ¨¡å‹çš„æµ‹è¯•ï¼Œè¯´æ˜éœ€è¦å®ç°å“ªäº›åŠŸèƒ½ã€æµ‹è¯•çš„ä¼˜å…ˆçº§å’ŒéªŒæ”¶æ ‡å‡†ã€‚

å…·ä½“çš„ä»£ç å®ç°å’Œæµ‹è¯•ç”¨ä¾‹ç”±ä½ é€æ­¥å®Œæˆï¼Œæœ¬æ–‡æ¡£ä½œä¸º**è·¯çº¿å›¾å’Œæ£€æŸ¥æ¸…å•**ã€‚

---

## æµ‹è¯•å“²å­¦

### æ ¸å¿ƒåŸåˆ™

1. **æ¸è¿›å¼**ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰å¯è¿è¡Œçš„ç‰ˆæœ¬
2. **å¯éªŒè¯**ï¼šæ¯ä¸ªåŠŸèƒ½éƒ½æœ‰æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†
3. **å¯¹ç…§ Go Runtime**ï¼šå…³é”®è¡Œä¸ºä¸ Go runtime ä¿æŒä¸€è‡´
4. **å­¦ä¹ å¯¼å‘**ï¼šæµ‹è¯•å¸®åŠ©ç†è§£ GMP æ¨¡å‹çš„å·¥ä½œåŸç†

### æµ‹è¯•é‡‘å­—å¡”

```
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  é›†æˆæµ‹è¯•   â”‚  â† å®Œæ•´çš„è°ƒåº¦åœºæ™¯
           â”‚   (10%)     â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚  åŠŸèƒ½æµ‹è¯•   â”‚  â† ç»„ä»¶åä½œï¼ˆP+M, M+Gï¼‰
           â”‚   (30%)     â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚  å•å…ƒæµ‹è¯•   â”‚  â† å•ä¸ªç»„ä»¶ï¼ˆG, P, M, Schedï¼‰
           â”‚   (60%)     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æµ‹è¯•é˜¶æ®µè§„åˆ’

### ğŸ“Š æ€»è§ˆ

| é˜¶æ®µ              | ç›®æ ‡           | æ ¸å¿ƒåŠŸèƒ½             | ä¼˜å…ˆçº§ |
| ----------------- | -------------- | -------------------- | ------ |
| **Phase 1** | æœ€å°å¯è¿è¡Œç‰ˆæœ¬ | G çš„åˆ›å»ºå’Œæ‰§è¡Œ       | ğŸ”´ P0  |
| **Phase 2** | æœ¬åœ°é˜Ÿåˆ—è°ƒåº¦   | P çš„é˜Ÿåˆ— + å• M è°ƒåº¦ | ğŸ”´ P0  |
| **Phase 3** | å…¨å±€é˜Ÿåˆ—       | æº¢å‡ºå’Œå…¨å±€é˜Ÿåˆ—æ£€æŸ¥   | ğŸŸ¡ P1  |
| **Phase 4** | å¤š P å¤š M      | å¹¶å‘è°ƒåº¦             | ğŸŸ¡ P1  |
| **Phase 5** | å·¥ä½œçªƒå–       | è´Ÿè½½å‡è¡¡             | ğŸŸ¢ P2  |
| **Phase 6** | å¯è§‚æµ‹æ€§       | ç»Ÿè®¡å’Œæ—¥å¿—           | ğŸŸ¢ P2  |

---

## Phase 1: æœ€å°å¯è¿è¡Œç‰ˆæœ¬

### ç›®æ ‡

å®ç°æœ€ç®€å•çš„ Gï¼ˆGoroutineï¼‰åˆ›å»ºå’Œæ‰§è¡Œï¼ŒéªŒè¯åŸºç¡€æ•°æ®ç»“æ„ã€‚

### éœ€è¦å®ç°çš„åŠŸèƒ½

1. **G çš„åˆ›å»º**

   - ç”Ÿæˆå”¯ä¸€çš„ goid
   - è®¾ç½®åˆå§‹çŠ¶æ€ä¸º Gidle
   - å…³è”è¦æ‰§è¡Œçš„å‡½æ•°
2. **G çš„æ‰§è¡Œ**

   - çŠ¶æ€è½¬æ¢ï¼šGidle â†’ Grunning â†’ Gdead
   - æ‰§è¡Œå…³è”çš„å‡½æ•°
   - å‡½æ•°æ‰§è¡Œå®Œæ¯•åæ¸…ç†
3. **åŸºç¡€ Sched ç»“æ„**

   - goidgen ç®¡ç†
   - ç®€å•çš„åˆå§‹åŒ–

### æµ‹è¯•æ¸…å•

#### âœ… å•å…ƒæµ‹è¯• (g_test.go)

- [X] **TestCreateG** - åˆ›å»ºå•ä¸ª G

  - éªŒè¯ï¼šgoid > 0
  - éªŒè¯ï¼šåˆå§‹çŠ¶æ€ä¸º Gidle
  - éªŒè¯ï¼šfn ä¸ä¸º nil
- [X] **TestGoidUnique** - goid å”¯ä¸€æ€§

  - åˆ›å»º 100 ä¸ª G
  - éªŒè¯ï¼šæ‰€æœ‰ goid äº’ä¸ç›¸åŒ
  - éªŒè¯ï¼šgoid é€’å¢
- [X] **TestGoidConcurrent** - å¹¶å‘åˆ›å»º G çš„ goid å”¯ä¸€æ€§

  - 10 ä¸ª goroutine å¹¶å‘åˆ›å»º G
  - éªŒè¯ï¼šæ— é‡å¤ goid
- [X] **TestExecuteG** - æ‰§è¡Œ G

  - éªŒè¯ï¼šfn è¢«è°ƒç”¨
  - éªŒè¯ï¼šçŠ¶æ€å˜ä¸º Gdead
- [ ] **TestExecuteGWithResult** - æ‰§è¡Œ G å¹¶éªŒè¯ç»“æœ

  - G çš„å‡½æ•°ä¿®æ”¹å¤–éƒ¨å˜é‡
  - éªŒè¯ï¼šå˜é‡è¢«æ­£ç¡®ä¿®æ”¹

#### âœ… å•å…ƒæµ‹è¯• (sched_test.go)

- [ ] **TestSchedInit** - è°ƒåº¦å™¨åˆå§‹åŒ–
  - éªŒè¯ï¼šgoidgen åˆå§‹åŒ–ä¸º 0
  - éªŒè¯ï¼šå¯ä»¥åˆ›å»º G

### éªŒæ”¶æ ‡å‡†

- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… å¯ä»¥åˆ›å»º G å¹¶æ‰§è¡Œå‡½æ•°
- âœ… goid åœ¨å¹¶å‘ç¯å¢ƒä¸‹å”¯ä¸€
- âœ… ä»£ç è¦†ç›–ç‡ > 80%

### å­¦ä¹ ç›®æ ‡

ç†è§£ï¼š

- G çš„åŸºæœ¬ç»“æ„
- åŸå­æ“ä½œä¿è¯ goid å”¯ä¸€æ€§
- G çš„çŠ¶æ€è½¬æ¢

---

## Phase 2: æœ¬åœ°é˜Ÿåˆ—è°ƒåº¦

### ç›®æ ‡

å®ç° P çš„æœ¬åœ°é˜Ÿåˆ—å’Œå•ä¸ª M çš„è°ƒåº¦å¾ªç¯ï¼Œèƒ½å¤Ÿé¡ºåºæ‰§è¡Œå¤šä¸ª Gã€‚

### éœ€è¦å®ç°çš„åŠŸèƒ½

1. **P çš„æœ¬åœ°é˜Ÿåˆ—**

   - å›ºå®šå¤§å°å¾ªç¯æ•°ç»„ï¼ˆ256ï¼‰
   - runqputï¼šå…¥é˜Ÿ
   - runqgetï¼šå‡ºé˜Ÿ
   - é˜Ÿåˆ—æ»¡åˆ¤æ–­
2. **runnext æœºåˆ¶**

   - æ–° G ä¼˜å…ˆæ”¾å…¥ runnext
   - runqget ä¼˜å…ˆå– runnext
3. **å• M è°ƒåº¦å¾ªç¯**

   - ä» P çš„é˜Ÿåˆ—å– G
   - æ‰§è¡Œ G
   - å¾ªç¯ç›´åˆ°é˜Ÿåˆ—ä¸ºç©º

### æµ‹è¯•æ¸…å•

#### âœ… å•å…ƒæµ‹è¯• (p_test.go)

- [ ] **TestCreateP** - åˆ›å»º P

  - éªŒè¯ï¼šid æ­£ç¡®
  - éªŒè¯ï¼šé˜Ÿåˆ—ä¸ºç©ºï¼ˆhead == tailï¼‰
- [ ] **TestRunqPutGet** - é˜Ÿåˆ—åŸºæœ¬æ“ä½œ

  - å…¥é˜Ÿ 1 ä¸ª G
  - éªŒè¯ï¼šé˜Ÿåˆ—é•¿åº¦ä¸º 1
  - å‡ºé˜Ÿ
  - éªŒè¯ï¼šå–å‡ºçš„æ˜¯åŒä¸€ä¸ª G
  - éªŒè¯ï¼šé˜Ÿåˆ—ä¸ºç©º
- [ ] **TestRunqMultiple** - å¤šä¸ª G çš„é˜Ÿåˆ—æ“ä½œ

  - å…¥é˜Ÿ 10 ä¸ª G
  - éªŒè¯ï¼šé¡ºåºå‡ºé˜Ÿï¼ŒFIFO
- [ ] **TestRunqFull** - é˜Ÿåˆ—æ»¡çš„æƒ…å†µ

  - å…¥é˜Ÿ 256 ä¸ª G
  - éªŒè¯ï¼šé˜Ÿåˆ—æ»¡
  - å°è¯•å†å…¥é˜Ÿ
  - éªŒè¯ï¼šå…¥é˜Ÿå¤±è´¥æˆ–è¿”å› false
- [ ] **TestRunqCircular** - å¾ªç¯æ•°ç»„éªŒè¯

  - å…¥é˜Ÿ 100 ä¸ª Gï¼Œå‡ºé˜Ÿ 100 ä¸ª
  - å†å…¥é˜Ÿ 200 ä¸ª G
  - éªŒè¯ï¼šhead å’Œ tail æ­£ç¡®å¾ªç¯
- [ ] **TestRunnext** - runnext æœºåˆ¶

  - åˆ›å»º G1ï¼Œæ”¾å…¥ runnext
  - åˆ›å»º G2ï¼Œæ”¾å…¥ runnext
  - éªŒè¯ï¼šG1 è¢«æŒ¤åˆ°é˜Ÿåˆ—ï¼ŒG2 åœ¨ runnext
  - å– G
  - éªŒè¯ï¼šå…ˆå–åˆ° G2ï¼ˆrunnext ä¼˜å…ˆï¼‰

#### âœ… å•å…ƒæµ‹è¯• (m_test.go)

- [ ] **TestCreateM** - åˆ›å»º M

  - éªŒè¯ï¼šid æ­£ç¡®
  - éªŒè¯ï¼šåˆå§‹çŠ¶æ€æ­£ç¡®
- [ ] **TestMBindP** - M ç»‘å®š P

  - åˆ›å»º M å’Œ P
  - ç»‘å®š
  - éªŒè¯ï¼šm.p == p && p.m == m

#### âœ… åŠŸèƒ½æµ‹è¯• (schedule_test.go)

- [ ] **TestScheduleSingleG** - è°ƒåº¦å•ä¸ª G

  - åˆ›å»º Pã€Mã€G
  - æ‰§è¡Œè°ƒåº¦
  - éªŒè¯ï¼šG è¢«æ‰§è¡Œ
- [ ] **TestScheduleMultipleG** - è°ƒåº¦å¤šä¸ª Gï¼ˆé¡ºåºï¼‰

  - åˆ›å»º 10 ä¸ª G æ”¾å…¥ P çš„é˜Ÿåˆ—
  - å• M æ‰§è¡Œè°ƒåº¦å¾ªç¯
  - éªŒè¯ï¼šæ‰€æœ‰ G éƒ½æ‰§è¡Œå®Œæ¯•
  - éªŒè¯ï¼šæ‰§è¡Œé¡ºåºç¬¦åˆ FIFO

### éªŒæ”¶æ ‡å‡†

- âœ… P çš„é˜Ÿåˆ—æ­£ç¡®å·¥ä½œï¼ˆFIFOï¼‰
- âœ… runnext ä¼˜å…ˆçº§æ­£ç¡®
- âœ… å• M èƒ½é¡ºåºæ‰§è¡Œå¤šä¸ª G
- âœ… é˜Ÿåˆ—æ»¡æ—¶æ­£ç¡®å¤„ç†
- âœ… ä»£ç è¦†ç›–ç‡ > 80%

### å­¦ä¹ ç›®æ ‡

ç†è§£ï¼š

- P çš„æœ¬åœ°é˜Ÿåˆ—è®¾è®¡ï¼ˆå¾ªç¯æ•°ç»„ï¼‰
- runnext çš„å±€éƒ¨æ€§ä¼˜åŒ–
- M çš„è°ƒåº¦å¾ªç¯åŸºæœ¬æµç¨‹

---

## Phase 3: å…¨å±€é˜Ÿåˆ—

### ç›®æ ‡

å®ç°å…¨å±€é˜Ÿåˆ—ï¼Œå¤„ç†æœ¬åœ°é˜Ÿåˆ—æº¢å‡ºå’Œé˜²é¥¥é¥¿æœºåˆ¶ã€‚

### éœ€è¦å®ç°çš„åŠŸèƒ½

1. **å…¨å±€é˜Ÿåˆ—**

   - é“¾è¡¨æˆ–åˆ‡ç‰‡å®ç°
   - çº¿ç¨‹å®‰å…¨ï¼ˆé”ä¿æŠ¤ï¼‰
   - globrunqputï¼šå…¥é˜Ÿ
   - globrunqgetï¼šå‡ºé˜Ÿ
2. **æœ¬åœ°é˜Ÿåˆ—æº¢å‡º**

   - æœ¬åœ°é˜Ÿåˆ—æ»¡æ—¶ï¼Œè½¬ç§»ä¸€åŠåˆ°å…¨å±€é˜Ÿåˆ—
3. **é˜²é¥¥é¥¿æœºåˆ¶**

   - æ¯ 61 æ¬¡è°ƒåº¦æ£€æŸ¥å…¨å±€é˜Ÿåˆ—
   - schedtick è®¡æ•°

### æµ‹è¯•æ¸…å•

#### âœ… å•å…ƒæµ‹è¯• (sched_test.go)

- [ ] **TestGlobalQueue** - å…¨å±€é˜Ÿåˆ—åŸºæœ¬æ“ä½œ

  - å…¥é˜Ÿ 10 ä¸ª G
  - éªŒè¯ï¼šé˜Ÿåˆ—é•¿åº¦æ­£ç¡®
  - å‡ºé˜Ÿ
  - éªŒè¯ï¼šFIFO
- [ ] **TestGlobalQueueConcurrent** - å…¨å±€é˜Ÿåˆ—å¹¶å‘å®‰å…¨

  - 10 ä¸ª goroutine å¹¶å‘å…¥é˜Ÿ
  - 10 ä¸ª goroutine å¹¶å‘å‡ºé˜Ÿ
  - éªŒè¯ï¼šæ— æ•°æ®ç«äº‰ï¼Œæ— ä¸¢å¤±

#### âœ… åŠŸèƒ½æµ‹è¯• (schedule_test.go)

- [ ] **TestLocalQueueOverflow** - æœ¬åœ°é˜Ÿåˆ—æº¢å‡º

  - åˆ›å»º 300 ä¸ª G
  - æ”¾å…¥ P çš„é˜Ÿåˆ—
  - éªŒè¯ï¼šæœ¬åœ°é˜Ÿåˆ—æœ‰ 128 ä¸ªï¼ˆ256 çš„ä¸€åŠï¼‰
  - éªŒè¯ï¼šå…¨å±€é˜Ÿåˆ—æœ‰ 172 ä¸ªï¼ˆ300 - 128ï¼‰
- [ ] **TestGlobalQueueStarvation** - é˜²é¥¥é¥¿

  - å…¨å±€é˜Ÿåˆ— 100 ä¸ª G
  - æœ¬åœ°é˜Ÿåˆ— 10 ä¸ª G
  - æ‰§è¡Œè°ƒåº¦
  - éªŒè¯ï¼šæ¯ 61 æ¬¡ä»å…¨å±€é˜Ÿåˆ—å– G
  - éªŒè¯ï¼šå…¨å±€é˜Ÿåˆ—çš„ G ä¹Ÿè¢«æ‰§è¡Œ

### éªŒæ”¶æ ‡å‡†

- âœ… å…¨å±€é˜Ÿåˆ—çº¿ç¨‹å®‰å…¨
- âœ… æœ¬åœ°é˜Ÿåˆ—æ»¡æ—¶æ­£ç¡®æº¢å‡º
- âœ… å…¨å±€é˜Ÿåˆ—çš„ G ä¸ä¼šé¥¥é¥¿
- âœ… schedtick è®¡æ•°æ­£ç¡®
- âœ… ä»£ç è¦†ç›–ç‡ > 75%

### å­¦ä¹ ç›®æ ‡

ç†è§£ï¼š

- å…¨å±€é˜Ÿåˆ—çš„ä½œç”¨
- æœ¬åœ°é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—çš„åä½œ
- é˜²é¥¥é¥¿æœºåˆ¶ï¼ˆæ¯ 61 æ¬¡ï¼‰

---

## Phase 4: å¤š P å¤š M

### ç›®æ ‡

å®ç°å¤šä¸ª P å’Œ M çš„å¹¶å‘è°ƒåº¦ï¼ŒéªŒè¯è´Ÿè½½åˆ†é…ã€‚

### éœ€è¦å®ç°çš„åŠŸèƒ½

1. **å¤š P ç®¡ç†**

   - æ ¹æ® GOMAXPROCS åˆ›å»ºå¤šä¸ª P
   - allp æ•°ç»„
   - P çš„çŠ¶æ€ç®¡ç†
2. **å¤š M ç®¡ç†**

   - åˆ›å»ºå¤šä¸ª M
   - M å’Œ P çš„ç»‘å®š
   - allm é“¾è¡¨
3. **å¹¶å‘è°ƒåº¦**

   - æ¯ä¸ª M ç‹¬ç«‹è°ƒåº¦å…¶ç»‘å®šçš„ P
   - M ä¹‹é—´ä¸ç«äº‰ï¼ˆæš‚æ— å·¥ä½œçªƒå–ï¼‰

### æµ‹è¯•æ¸…å•

#### âœ… å•å…ƒæµ‹è¯• (sched_test.go)

- [ ] **TestSchedInitMultiP** - åˆå§‹åŒ–å¤šä¸ª P

  - è®¾ç½® GOMAXPROCS=4
  - è°ƒç”¨ schedinit
  - éªŒè¯ï¼šåˆ›å»ºäº† 4 ä¸ª P
  - éªŒè¯ï¼šP çš„ id ä¸º 0-3
- [ ] **TestCreateMultiM** - åˆ›å»ºå¤šä¸ª M

  - åˆ›å»º 4 ä¸ª M
  - éªŒè¯ï¼šM çš„ id å”¯ä¸€ä¸”é€’å¢

#### âœ… åŠŸèƒ½æµ‹è¯• (schedule_test.go)

- [ ] **TestMultiPSchedule** - å¤š P è°ƒåº¦

  - 4 ä¸ª Pï¼Œ4 ä¸ª M
  - åˆ›å»º 100 ä¸ª Gï¼Œå‡åŒ€åˆ†é…åˆ° P
  - å¹¶å‘æ‰§è¡Œè°ƒåº¦
  - éªŒè¯ï¼šæ‰€æœ‰ G éƒ½æ‰§è¡Œå®Œæ¯•
- [ ] **TestLoadDistribution** - è´Ÿè½½åˆ†å¸ƒ

  - 4 ä¸ª P
  - åˆ›å»º 1000 ä¸ª Gï¼Œéšæœºåˆ†é…
  - ç»Ÿè®¡æ¯ä¸ª P æ‰§è¡Œçš„ G æ•°é‡
  - éªŒè¯ï¼šåˆ†å¸ƒå¤§è‡´å‡åŒ€ï¼ˆå…è®¸ 20% è¯¯å·®ï¼‰

#### âœ… é›†æˆæµ‹è¯• (integration_test.go)

- [ ] **TestFullSchedulerBasic** - å®Œæ•´è°ƒåº¦å™¨åŸºç¡€åœºæ™¯
  - 4 Pï¼Œ4 M
  - åˆ›å»º 1000 ä¸ªç®€å•ä»»åŠ¡ G
  - éªŒè¯ï¼šæ‰€æœ‰ä»»åŠ¡å®Œæˆ
  - éªŒè¯ï¼šæ— æ­»é”

### éªŒæ”¶æ ‡å‡†

- âœ… å¤š P å¤š M æ­£ç¡®åˆ›å»º
- âœ… M å’Œ P æ­£ç¡®ç»‘å®š
- âœ… å¹¶å‘è°ƒåº¦æ— æ•°æ®ç«äº‰
- âœ… è´Ÿè½½åˆ†å¸ƒåˆç†
- âœ… ä»£ç è¦†ç›–ç‡ > 70%

### å­¦ä¹ ç›®æ ‡

ç†è§£ï¼š

- GOMAXPROCS çš„ä½œç”¨
- P å’Œ M çš„æ•°é‡å…³ç³»
- å¹¶å‘è°ƒåº¦çš„åŸºæœ¬æ¨¡å‹

---

## Phase 5: å·¥ä½œçªƒå–

### ç›®æ ‡

å®ç°å·¥ä½œçªƒå–ç®—æ³•ï¼Œä¼˜åŒ–è´Ÿè½½å‡è¡¡ã€‚

### éœ€è¦å®ç°çš„åŠŸèƒ½

1. **findrunnable**

   - æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—
   - æ£€æŸ¥å…¨å±€é˜Ÿåˆ—
   - å°è¯•çªƒå–
2. **runqsteal**

   - ä»ç›®æ ‡ P çªƒå–ä¸€åŠ G
   - éšæœºé€‰æ‹©çªƒå–ç›®æ ‡
3. **M çš„è‡ªæ—‹çŠ¶æ€**

   - spinning æ ‡è®°
   - nmspinning è®¡æ•°

### æµ‹è¯•æ¸…å•

#### âœ… å•å…ƒæµ‹è¯• (steal_test.go)

- [ ] **TestRunqSteal** - çªƒå–æ“ä½œ

  - P0 æœ‰ 100 ä¸ª G
  - P1 ä¸ºç©º
  - P1 ä» P0 çªƒå–
  - éªŒè¯ï¼šP0 å‰©ä½™çº¦ 50 ä¸ª
  - éªŒè¯ï¼šP1 è·å¾—çº¦ 50 ä¸ª
- [ ] **TestRunqStealEmpty** - çªƒå–ç©ºé˜Ÿåˆ—

  - P0 ä¸ºç©º
  - P1 å°è¯•çªƒå–
  - éªŒè¯ï¼šçªƒå–å¤±è´¥ï¼ŒP1 ä»ä¸ºç©º

#### âœ… åŠŸèƒ½æµ‹è¯• (schedule_test.go)

- [ ] **TestWorkStealing** - å·¥ä½œçªƒå–åœºæ™¯

  - 4 ä¸ª P
  - P0 æœ‰ 500 ä¸ª Gï¼Œå…¶ä»– P ä¸ºç©º
  - å¯åŠ¨ 4 ä¸ª M
  - æ‰§è¡Œè°ƒåº¦
  - éªŒè¯ï¼šæ‰€æœ‰ G éƒ½è¢«æ‰§è¡Œ
  - éªŒè¯ï¼šå‘ç”Ÿäº†çªƒå–ï¼ˆæ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯ï¼‰
- [ ] **TestStealBalance** - çªƒå–åçš„è´Ÿè½½å‡è¡¡

  - ä¸å¹³è¡¡è´Ÿè½½ï¼šP0=400, P1=0, P2=0, P3=0
  - æ‰§è¡Œè°ƒåº¦
  - éªŒè¯ï¼šæœ€ç»ˆè´Ÿè½½å¤§è‡´å‡è¡¡

#### âœ… æ€§èƒ½æµ‹è¯• (benchmark_test.go)

- [ ] **BenchmarkWithStealing** - æœ‰çªƒå–çš„æ€§èƒ½

  - 1000 ä¸ª Gï¼Œä¸å¹³è¡¡åˆ†å¸ƒ
  - æµ‹é‡å®Œæˆæ—¶é—´
- [ ] **BenchmarkWithoutStealing** - æ— çªƒå–çš„æ€§èƒ½ï¼ˆå¯¹æ¯”ï¼‰

  - åŒæ ·è´Ÿè½½ï¼Œä½†ç¦ç”¨çªƒå–
  - å¯¹æ¯”å®Œæˆæ—¶é—´

### éªŒæ”¶æ ‡å‡†

- âœ… çªƒå–é€»è¾‘æ­£ç¡®ï¼ˆçªƒå–ä¸€åŠï¼‰
- âœ… çªƒå–èƒ½æ”¹å–„è´Ÿè½½å‡è¡¡
- âœ… ç©ºé—² M èƒ½é€šè¿‡çªƒå–æ‰¾åˆ°å·¥ä½œ
- âœ… æ€§èƒ½æµ‹è¯•æ˜¾ç¤ºçªƒå–çš„ä¼˜åŠ¿
- âœ… ä»£ç è¦†ç›–ç‡ > 70%

### å­¦ä¹ ç›®æ ‡

ç†è§£ï¼š

- å·¥ä½œçªƒå–çš„åŸç†
- çªƒå–æ•°é‡çš„é€‰æ‹©ï¼ˆä¸€åŠï¼‰
- è‡ªæ—‹å’Œçªƒå–çš„é…åˆ

---

## Phase 6: å¯è§‚æµ‹æ€§

### ç›®æ ‡

æ·»åŠ ç»Ÿè®¡ã€æ—¥å¿—å’Œè°ƒè¯•åŠŸèƒ½ï¼Œä¾¿äºç†è§£è°ƒåº¦è¿‡ç¨‹ã€‚

### éœ€è¦å®ç°çš„åŠŸèƒ½

1. **ç»Ÿè®¡ä¿¡æ¯**

   - æ¯ä¸ª P æ‰§è¡Œçš„ G æ•°é‡
   - çªƒå–æ¬¡æ•°
   - å…¨å±€é˜Ÿåˆ—ä½¿ç”¨ç‡
2. **æ—¥å¿—è¾“å‡º**

   - å¯é…ç½®çš„æ—¥å¿—çº§åˆ«
   - å…³é”®äº‹ä»¶è®°å½•ï¼ˆåˆ›å»º Gã€è°ƒåº¦ã€çªƒå–ï¼‰
3. **schedtrace è¾“å‡º**

   - ç±»ä¼¼ GODEBUG=schedtrace
   - å®šæœŸè¾“å‡ºè°ƒåº¦çŠ¶æ€

### æµ‹è¯•æ¸…å•

#### âœ… å•å…ƒæµ‹è¯• (stats_test.go)

- [ ] **TestStats** - ç»Ÿè®¡åŠŸèƒ½

  - æ‰§è¡Œä¸€äº›è°ƒåº¦
  - éªŒè¯ï¼šç»Ÿè®¡æ•°æ®æ­£ç¡®
- [ ] **TestSchedTrace** - schedtrace è¾“å‡º

  - æ‰§è¡Œè°ƒåº¦
  - æ•è·è¾“å‡º
  - éªŒè¯ï¼šè¾“å‡ºæ ¼å¼æ­£ç¡®

#### âœ… é›†æˆæµ‹è¯• (integration_test.go)

- [ ] **TestObservability** - å®Œæ•´å¯è§‚æµ‹æ€§
  - è¿è¡Œå¤æ‚åœºæ™¯
  - è¾“å‡ºæ—¥å¿—å’Œç»Ÿè®¡
  - éªŒè¯ï¼šèƒ½é€šè¿‡æ—¥å¿—ç†è§£è°ƒåº¦è¿‡ç¨‹

### éªŒæ”¶æ ‡å‡†

- âœ… ç»Ÿè®¡æ•°æ®å‡†ç¡®
- âœ… æ—¥å¿—è¾“å‡ºæ¸…æ™°
- âœ… schedtrace æ ¼å¼æ­£ç¡®
- âœ… èƒ½å¸®åŠ©è°ƒè¯•å’Œå­¦ä¹ 

### å­¦ä¹ ç›®æ ‡

ç†è§£ï¼š

- å¦‚ä½•è§‚æµ‹è°ƒåº¦å™¨è¡Œä¸º
- GODEBUG=schedtrace çš„å«ä¹‰
- ç»Ÿè®¡å¯¹è°ƒä¼˜çš„ä»·å€¼

---

## æµ‹è¯•æ–‡ä»¶ç»“æ„

å»ºè®®çš„æµ‹è¯•æ–‡ä»¶ç»„ç»‡ï¼š

```
src/gmp/
â”œâ”€â”€ g_test.go            # G çš„å•å…ƒæµ‹è¯•
â”œâ”€â”€ p_test.go            # P çš„å•å…ƒæµ‹è¯•
â”œâ”€â”€ m_test.go            # M çš„å•å…ƒæµ‹è¯•
â”œâ”€â”€ sched_test.go        # Sched çš„å•å…ƒæµ‹è¯•
â”œâ”€â”€ schedule_test.go     # è°ƒåº¦é€»è¾‘çš„åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ steal_test.go        # å·¥ä½œçªƒå–çš„æµ‹è¯•
â”œâ”€â”€ stats_test.go        # ç»Ÿè®¡åŠŸèƒ½çš„æµ‹è¯•
â”œâ”€â”€ integration_test.go  # é›†æˆæµ‹è¯•
â””â”€â”€ benchmark_test.go    # æ€§èƒ½æµ‹è¯•
```

---

## æµ‹è¯•æ•°æ®å»ºè®®

### å°è§„æ¨¡ï¼ˆå•å…ƒæµ‹è¯•ï¼‰

- G æ•°é‡ï¼š1-100
- P æ•°é‡ï¼š1-4
- M æ•°é‡ï¼š1-4

### ä¸­è§„æ¨¡ï¼ˆåŠŸèƒ½æµ‹è¯•ï¼‰

- G æ•°é‡ï¼š100-1000
- P æ•°é‡ï¼š4-8
- M æ•°é‡ï¼š4-8

### å¤§è§„æ¨¡ï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰

- G æ•°é‡ï¼š10000-100000
- P æ•°é‡ï¼šruntime.NumCPU()
- M æ•°é‡ï¼šruntime.NumCPU() * 2

---

## æµ‹è¯•å·¥å…·å’Œå‘½ä»¤

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test -v ./...

# è¿è¡Œç‰¹å®šæµ‹è¯•
go test -v -run TestCreateG

# å¹¶å‘æµ‹è¯•ï¼ˆæ£€æµ‹æ•°æ®ç«äº‰ï¼‰
go test -race -v ./...

# è¦†ç›–ç‡
go test -cover ./...
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### æ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œ benchmark
go test -bench=. -benchmem

# å¯¹æ¯”æ€§èƒ½
go test -bench=. -benchmem > old.txt
# ... ä¿®æ”¹ä»£ç  ...
go test -bench=. -benchmem > new.txt
benchcmp old.txt new.txt
```

---

## æˆåŠŸæ ‡å‡†

### å®Œæˆ Phase 1-2

- ğŸ¯ **æœ€å°ç›®æ ‡**ï¼šå• M èƒ½æ‰§è¡Œå¤šä¸ª G
- ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ > 75%
- âœ… æ— æ•°æ®ç«äº‰

### å®Œæˆ Phase 3-4

- ğŸ¯ **åŸºç¡€ç›®æ ‡**ï¼šå¤š M å¤š P å¹¶å‘è°ƒåº¦
- ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ > 70%
- âœ… æ€§èƒ½åŸºå‡†å»ºç«‹

### å®Œæˆ Phase 5-6

- ğŸ¯ **å®Œæ•´ç›®æ ‡**ï¼šå·¥ä½œçªƒå– + å¯è§‚æµ‹æ€§
- ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ > 65%
- âœ… å®Œæ•´æ–‡æ¡£å’Œç¤ºä¾‹

---

## é™„å½•ï¼šæµ‹è¯•æ¨¡æ¿

### å•å…ƒæµ‹è¯•æ¨¡æ¿

```go
func TestFeatureName(t *testing.T) {
    // 1. å‡†å¤‡ (Arrange)
    // åˆ›å»ºæµ‹è¯•æ•°æ®

    // 2. æ‰§è¡Œ (Act)
    // è°ƒç”¨è¢«æµ‹è¯•çš„å‡½æ•°

    // 3. éªŒè¯ (Assert)
    // æ£€æŸ¥ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸ
    if got != want {
        t.Errorf("æœŸæœ› %v, å®é™… %v", want, got)
    }
}
```

### å¹¶å‘æµ‹è¯•æ¨¡æ¿

```go
func TestFeatureConcurrent(t *testing.T) {
    const goroutines = 10
    const iterations = 100

    var wg sync.WaitGroup
    wg.Add(goroutines)

    for i := 0; i < goroutines; i++ {
        go func() {
            defer wg.Done()
            for j := 0; j < iterations; j++ {
                // å¹¶å‘æ‰§è¡Œçš„æ“ä½œ
            }
        }()
    }

    wg.Wait()
    // éªŒè¯ç»“æœ
}
```

### æ€§èƒ½æµ‹è¯•æ¨¡æ¿

```go
func BenchmarkFeature(b *testing.B) {
    // å‡†å¤‡
    setup()

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        // è¢«æµ‹è¯•çš„æ“ä½œ
    }
}
```

---

**ä½¿ç”¨å»ºè®®**ï¼š

1. **æŒ‰é˜¶æ®µå®ç°**ï¼šä¸è¦è·³è·ƒï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µéƒ½é€šè¿‡æµ‹è¯•å†è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
2. **å…ˆå†™æµ‹è¯•**ï¼šéµå¾ª TDDï¼Œå…ˆå†™å¤±è´¥çš„æµ‹è¯•ï¼Œå†å®ç°åŠŸèƒ½
3. **å°æ­¥å¿«è·‘**ï¼šæ¯å®ç°ä¸€ä¸ªå°åŠŸèƒ½å°±è¿è¡Œæµ‹è¯•
4. **è®°å½•è¿›åº¦**ï¼šç”¨ `[ ]` å’Œ `[x]` æ ‡è®°æµ‹è¯•æ¸…å•ï¼Œè¿½è¸ªè¿›åº¦
5. **æäº¤ä»£ç **ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆå git commitï¼Œæ–¹ä¾¿å›é€€

ç¥æµ‹è¯•é¡ºåˆ©ï¼é€šè¿‡è¿™äº›æµ‹è¯•ï¼Œä½ ä¼šæ·±åˆ»ç†è§£ GMP æ¨¡å‹çš„æ¯ä¸ªç»†èŠ‚ã€‚ğŸ‰
